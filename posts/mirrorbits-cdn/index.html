<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/posts/rss.xml" title="Jellyfin RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/posts/atom.xml" title="Jellyfin Atom Feed"><title data-rh="true">The Jellyfin CDN: Mirrorbits for the masses | Jellyfin</title><meta data-rh="true" property="og:image" content="http://next.jellyfin.org/images/social.png"><meta data-rh="true" name="twitter:image" content="http://next.jellyfin.org/images/social.png"><meta data-rh="true" property="og:url" content="http://next.jellyfin.org/posts/mirrorbits-cdn"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:site" content="@jellyfin"><meta data-rh="true" property="og:title" content="The Jellyfin CDN: Mirrorbits for the masses | Jellyfin"><meta data-rh="true" name="description" content="How Jellyfin distributes binary packages"><meta data-rh="true" property="og:description" content="How Jellyfin distributes binary packages"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-04-12T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/joshuaboniface"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="http://next.jellyfin.org/posts/mirrorbits-cdn"><link data-rh="true" rel="alternate" href="http://next.jellyfin.org/posts/mirrorbits-cdn" hreflang="en"><link data-rh="true" rel="alternate" href="http://next.jellyfin.org/posts/mirrorbits-cdn" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bdd7615e.css">
<link rel="preload" href="/assets/js/runtime~main.c3f67a5c.js" as="script">
<link rel="preload" href="/assets/js/main.d391ae15.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#b71c1c;color:#ffffff" role="banner"><div class="announcementBarContent_xLdY">This new version of Jellyfin.org is currently being built. <a target="_blank" rel="noopener noreferrer" href="https://github.com/jellyfin/jellyfin.org">Get involved!</a></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="Jellyfin Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/images/logo.svg" alt="Jellyfin Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/posts">Blog</a><a class="navbar__item navbar__link" href="/clients">Clients</a><a class="navbar__item navbar__link" href="/downloads">Downloads</a><a class="navbar__item navbar__link" href="/contribute">Contribute</a><a class="navbar__item navbar__link" href="/docs/getting-started">Documentation</a><a class="navbar__item navbar__link" href="/contact">Contact</a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts/roku-v1.5.0">Jellyfin Roku Release - v1.5.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts/webos-july2022">Jellyfin for webOS - July 2022 Update</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts/jellyfin-10-8-0">Jellyfin Release - v10.8.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts/ios-update-150">Updating our iOS App</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts/android-tv-13">Android TV v0.13</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">The Jellyfin CDN: Mirrorbits for the masses</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-04-12T00:00:00.000Z" itemprop="datePublished">April 12, 2021</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/joshuaboniface" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/4031396?v=4" alt="Joshua Boniface"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/joshuaboniface" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Boniface</span></a></div></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>For many projects, distributing binary assets is easy: put the files on GitHub and you&#x27;re done. It&#x27;s not something many think about. But at Jellyfin, we needed something more robust, something able to handle our needs more elegantly than GitHub or a basic web server could. And both for those interested, and for those supporting other similar projects, I&#x27;d like to share how we do it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prelude---pre-1060">Prelude - Pre-10.6.0<a class="hash-link" href="#prelude---pre-1060" title="Direct link to heading">​</a></h2><p>Before our 10.6.0 release, we had a fairly simple repository setup: everything would build on a VPS, running Debian, called <code>build1</code>, in response to a GitHub web-hook. This server, located on Digital Ocean in the Toronto zone, housed both the build process as well as our main repository, served directly via NGiNX.</p><p>But this release was the first where we noticed a problem. Jellyfin is a global project, and while I&#x27;m personally located in Ontario, Canada, the very vast majority of our users are not. And users, especially users in Europe and Asia, were having trouble downloading our releases. The main complaint was abysmally slow download speeds, and occasionally even full-on timeouts. We had to come up with a better solution.</p><p>As a DIYer at heart, and leading a project built by and for DIYers, I wasn&#x27;t content to simply throw CloudFlare in front of the repo - my concerns with that provider notwithstanding. I wanted something we could control, and I went looking for a solution - how to effectively create a CDN for file downloads.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-mirrorbits">Enter Mirrorbits<a class="hash-link" href="#enter-mirrorbits" title="Direct link to heading">​</a></h2><p>Luckily, I wasn&#x27;t alone. Many years before, another FLOSS project had encountered the same problem. VideoLAN, creators of the fantastic VLC Media Player, had the same issue of distributing files. So one of their talented developers created a solution: Mirrorbits.</p><p><a href="https://github.com/etix/mirrorbits" target="_blank" rel="noopener noreferrer">Mirrorbits</a> is a Go program with a single goal: provide a way to distribute requests from a single central repository to multiple geo-diverse repositories, based on the client&#x27;s GeoIP information, handling availability and freshness seamlessly. It seemed to fit the bill exactly.</p><p>But there was a problem: documentation on how to actually run Mirrorbits was sparse, so it took quite a bit of trial-and-error to determine how to use it. I hope the following will help avoid this trouble for anyone else.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-layout">File Layout<a class="hash-link" href="#file-layout" title="Direct link to heading">​</a></h2><p>The first thing to consider is the layout of the files. In Jellyfin&#x27;s case, our repository is large and sprawling, constituting many different components including the server, clients, plugins, and various secondary files. Mirrorbits requires everything to be housed under one directory, and we needed a way to synchronize this whole directory easily. We also had a problem of our &quot;archives&quot;, old stable releases that we did not need or want synchronized to all of our mirror servers wasting space.</p><p>The solution I came up with was the following directory structure:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/srv/repository</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">               /mirror</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                      /releases</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                               /client</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                               /server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                               /plugin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                               etc.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                      /debian</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                             /dists</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                             /pool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                      /ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                             /dists</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                             /pool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                      /archive</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                      etc.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">               /releases --symlink--&gt; /mirror/releases</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">               /debian   --symlink--&gt; /mirror/debian</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">               etc.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In effect, everything is under a <code>/mirror</code> directory, with external symlinks to provide the root links we wanted.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-vpses-and-synchronization">Additional VPSes and Synchronization<a class="hash-link" href="#additional-vpses-and-synchronization" title="Direct link to heading">​</a></h2><p>The next step after crafting a usable file layout was to create some additional VPSes and determine how to synchronize the files.</p><p>Since our origin server is in Toronto, I wanted to ensure we had wide geographic coverage. as well as a dedicated CDN for the same region as the origin server, just in case it got overloaded. Thus, I created 4 additional VPSes:</p><ul><li><code>tor1.mirror.jellyfin.org</code>: Toronto, Ontario, Canada for North/South America East</li><li><code>sfo1.mirror.jellyfin.org</code>: San Francisco, California, USA for North/South America West</li><li><code>fra1.mirror.jellyfin.org</code>: Frankfurt, Germany (not France as commonly assumed!) for Europe and Africa</li><li><code>sgp1.mirror.jellyfin.org</code>: Singapore for Asia and Pacific</li></ul><p>One worry when first setting up these 4 VPSes was that they would not be enough, but so far, through another major release and several minor releases, we&#x27;ve had the complaints about download speed completely stop, so they must be working. In future, as Digital Ocean expands, we&#x27;d also be able to add other locations as well, for instance Bangalore, India, Africa, and perhaps additional Europe and South America instances.</p><p>With the VPSes created, I then looked into file synchronization, and there was only one program on my mind: <code>rsync</code>. But while most users know <code>rsync</code> for it&#x27;s <code>scp</code>-replacement functionality over SSH, I wanted something more robust without the need for handling SSH keys, and able to be extended further in the future, perhaps to untrusted (and untrusting) 3rd-party mirrors.</p><p>I thus opted to use the <code>rsync</code> daemon mode. Listening on port 873, it&#x27;s able to do everything <code>rsync</code>-over-SSH can do, only without encryption overhead or requiring SSH/shell authentication.</p><p>I first prepared the the local <code>/etc/rsyncd.conf</code> on the origin server (<code>build1</code>). By default, the Debian <code>rsync</code> package does not install the daemon service unless this file exists, but after adding it the daemon can be started.</p><p>To handle the aforementioned &quot;archives&quot;, I split the repository into two &quot;components&quot;: one with the archives, and one without. This would allow a given mirror to pull either the entire archive, or just the current stable repositories. And once we started offering the &quot;unstable&quot; builds that can be generated many dozens of times per day, I opted to include them in the &quot;archive&quot; component as well.</p><p>Here is our configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/rsyncd.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[mirror]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    path = /srv/repository/mirror</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    comment = Jellyfin mirror (stable only)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exclude = *unstable* *archive*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[mirror-full]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    path = /srv/repository/mirror</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    comment = Jellyfin mirror (all)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In many cases, it would be prudent to secure this, but since we wanted to open this up to anyone, I left the <code>rsync</code> endpoint completely exposed. Thus, if you want to host a local Jellyfin mirror - you can. Simply clone this rsync target and you&#x27;ll have a full copy of the Jellyfin mirror!</p><p>On the mirror servers, we still needed to get the content however. Ultimately, I decided that every &quot;official&quot; mirror copying the <em>full</em> content (including archives and unstable builds) was more prudent, so all of them synchronize the <code>mirror-full</code> source.</p><p>Each node thus has a simple cron job, set to run every 15 minutes, that downloads an updated copy of the repository from the origin:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/cron.d/mirror-sync</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">12,27,42,57 *  * * *  root  rsync -au --delete rsync://build1.jellyfin.org/mirror-full/ /srv/repository/mirror/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The slightly odd times were chosen specifically - the goal for 3rd parties, if and when we officially support them, would be to synchronize every X minutes on even intervals, e.g. at <code>00</code>, <code>30</code>, etc., from these &quot;official&quot; mirrors, instead of from build1 directly. This therefore ensures they would always be up-to-date before that time comes around, ensuring no additional delays for 3rd party mirrors. We don&#x27;t officially support this <em>yet</em>, but if our traffic continues to grow, we will probably expand to 3rd parties as well as additional Digital Ocean locations.</p><p>The <code>rsync</code> command should create the destination directory automatically, but to be prudent, I ensured it was created manually first. Thus, we now have 5 servers with exactly the same content, with the mirrors synchronizing from the origin every 15 minutes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="web-server-configuration">Web server Configuration<a class="hash-link" href="#web-server-configuration" title="Direct link to heading">​</a></h2><p>From the very beginning we have used NGiNX as the web server. The reasons are simple: maximum configuration flexibility, and performance. Apache has its place, but we didn&#x27;t need its additional features, and early on budget was tight. I&#x27;ve been so satisfied with it, I haven&#x27;t even considered a change.</p><p>On the mirrors, the configuration is dead-simple. Only a single &quot;site&quot; is configured, providing full access to the repository directory. SSL is provided by Let&#x27;s Encrypt.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/nginx/sites-enabled/jellyfin-mirror (from fra1.mirror.jellyfin.org)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen [::]:80 default_server ipv6only=on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen 80 default_server;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen [::]:443 ssl ipv6only=on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen 443 ssl;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ssl_certificate /etc/letsencrypt/live/fra1.mirror.jellyfin.org/fullchain.pem;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ssl_certificate_key /etc/letsencrypt/live/fra1.mirror.jellyfin.org/privkey.pem;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    server_name fra1.mirror.jellyfin.org _;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    root /srv/repository;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    index index.php index.html index.htm;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    access_log /var/log/nginx/access.log;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    aio threads;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    directio 1M;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    output_buffers 3 1M;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sendfile on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sendfile_max_chunk 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ~ [^/]\.php(/|$) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_split_path_info ^(.+?\.php)(/.*)$;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_param HTTP_PROXY &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_index index.php;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        include fastcgi_params;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During testing, we did notice one thing that might be of use to other admins. We were finding that performance, when many requests for large files came in at once, would drop significantly. I ended up tracing the problem to the I/O stack within NGiNX, which appeared to be a bottleneck. I was able to find some documentation about this problem, and thus have set the <code>aio threads</code>, <code>directio</code>, <code>output_buffers</code>, and <code>sendfile</code> options above. These ensure NGiNX will use direct I/O for any file larger than 1M, and provide 3 output buffers with a maximum chunk size of 0, increasing performance under load.</p><p>On the origin, the NGiNX configuration is much more complicated. Because Mirrorbits will only distribute the actual large files themselves, I need to handle any pre-file redirection first on the origin. Thus clients are directed to the right file location, and the Mirrorbits directs <em>that</em> request to the mirrors.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/nginx/sites-enabled/jellyfin-origin (on build1.jellyfin.org)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen 80 default_server proxy_protocol;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    listen [::]:80 default_server proxy_protocol;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    server_name repo.jellyfin.org build.jellyfin.org repo1.jellyfin.org build1.jellyfin.org _;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    access_log /var/log/nginx/access.log proxy;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    aio threads;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    directio 1M;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    output_buffers 3 1M;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sendfile on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    sendfile_max_chunk 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    root /srv/repository/mirror;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    index index.php index.html index.htm index.nginx-debian.html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex off;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Kodi Repository redirection</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ^~ /releases/client/kodi/py2 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        index index.html index.php;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ^~ /releases/client/kodi/py3 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        index index.html index.php;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ^~ /releases/client/kodi {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        # Kodi 20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if ($http_user_agent ~* &quot;(Kodi.*/20.*)&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            rewrite ^/releases/client/kodi/(.*)$ /releases/client/kodi/py3/$1 last;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        # Kodi 19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if ($http_user_agent ~* &quot;(Kodi.*/19.*)&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            rewrite ^/releases/client/kodi/(.*)$ /releases/client/kodi/py3/$1 last;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        # Kodi 18 and older</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if ($http_user_agent ~* &quot;(Kodi.*)&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            rewrite ^/releases/client/kodi/(.*)$ /releases/client/kodi/py2/$1 last;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        index index.html index.php;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Main repository</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Main release directories</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location /releases {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Main archive directories (not forwarded to Mirrorbits)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ^~ /archive {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        try_files $uri $uri/ =404;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Mirrorbits fallback</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ^~ /master {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        try_files $uri $uri/ =404;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        autoindex on;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # Mirrorbits forwards for large file types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ~ ^/(?&lt;fwd_path&gt;.*)(?&lt;fwd_file&gt;\.apk|\.buildinfo|\.bz|\.changes|\.db|\.deb|\.dmg|\.dsc|\.exe|\.gz|\.md5|\.lzma|\.rpm|\.sha256sum|\.xml|\.xz|\.zip|\.css|\.ttf|\.woff2|\.json)$ {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_pass http://127.0.0.1:8080;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_buffering off;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ~ ^/(?&lt;fwd_path&gt;.*)(/mirrorlist)$ {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_pass http://127.0.0.1:8080/$fwd_path?mirrorlist;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_buffering off;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ~ ^/(?&lt;fwd_path&gt;.*)(/mirrorstats)$ {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_pass http://127.0.0.1:8080/$fwd_path?mirrorstats;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_buffering off;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location /mirrorstats {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_pass http://127.0.0.1:8080/?mirrorstats;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_buffering off;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # PHP handling</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    location ~ \.php$ {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_split_path_info ^(.+?\.php)(/.*)$;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_param HTTP_PROXY &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_index index.php;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        include fastcgi_params;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some of the configuration here is worthy of describing in detail.</p><p>The Kodi selector is used due to the Kodi backend transition from Python 2 to Python 3. Thus, some versions require assets for Python 2, and newer versions for Python 3. This selector operates based on the sent user agent of the client, deciding which version of Kodi they are using, and thus directing them to the right location.</p><p>The main locations are <code>/archive</code>, <code>/releases</code>, and <code>/master</code>. The first contains archives and is not forwarded on to the Mirrorbits process (despite the files being synced above) due to the <code>try_files</code> directive. The second is the main repository directory, and the third is a duplicate location that is used for fallback and also does not redirect to Mirrorbits.</p><p>Next is the main Mirrorbits handler. The forwarding is based off the file extension of the requested file. Thus, when loading, e.g. the PHP index pages, the requests are not forwarded; only requests for the listed file types are forwarded on to the Mirrorbits process to be distributed to mirrors.</p><p>The next 3 options are for Mirrorbits status pages, which provide information on the currently available mirrors. For any file (e.g. <a href="https://repo.jellyfin.org/releases/server/debian/stable/meta/jellyfin_10.7.2-1_all.deb" target="_blank" rel="noopener noreferrer">https://repo.jellyfin.org/releases/server/debian/stable/meta/jellyfin_10.7.2-1_all.deb</a>), one can append the <code>/mirrorlist</code> or <code>/mirrorinfo</code> locations to show information about the available mirrors. Try it yourself: <a href="https://repo.jellyfin.org/releases/server/debian/stable/meta/jellyfin_10.7.2-1_all.deb/mirrorlist" target="_blank" rel="noopener noreferrer">https://repo.jellyfin.org/releases/server/debian/stable/meta/jellyfin_10.7.2-1_all.deb/mirrorlist</a>. Finally the <code>/mirrorstats</code> page, whether on a file or at the root of the domain (<a href="https://repo.jellyfin.org/mirrorstats" target="_blank" rel="noopener noreferrer">https://repo.jellyfin.org/mirrorstats</a>) shows the current status of the mirrors in general, including if any are offline.</p><p>All together, these NGiNX configs provide the foundation for Mirrorbits to work, and this was the part that actually took the longest. Thanks to <a href="https://github.com/PalinuroSec" target="_blank" rel="noopener noreferrer">@PalinuroSec</a> on GitHub for his <a href="https://gist.github.com/PalinuroSec/f0bfb815240573ab1b0b58f3c76620d4" target="_blank" rel="noopener noreferrer">fantastic example gist</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mirrorbits-the-workhorse">Mirrorbits: The Workhorse<a class="hash-link" href="#mirrorbits-the-workhorse" title="Direct link to heading">​</a></h2><p>Installing Mirrorbits is quite straightforward: I simply downloaded the latest binary release (<code>0.5.1</code>) from the Mirrorbits repository, installed the <code>mirrorbits</code> binary to <code>/usr/local/bin</code>, the sample configuration to <code>/etc/mirrorbits.conf</code>, and the templates to <code>/usr/local/share/mirrorbits</code>. Unfortunately, Mirrorbits development seems to have stalled since 2018, including documentation. <a href="https://github.com/etix/mirrorbits/issues/105" target="_blank" rel="noopener noreferrer">I opened an issue</a> during my troubleshooting that is still unanswered, which is unfortunate, and I hope this blog post will be able to resolve that issue.</p><p>The basic configuration of Mirrorbits is quite simple. Most of the configuration options are explained well in the sample configuration file, and it was simply a matter of tuning them to our needs. Here is our configuration stripped of comments/explanations:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/mirrorbits.conf (on build1.jellyfin.org)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Repository: /srv/repository/mirror</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Templates: /usr/local/share/mirrorbits/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LogDir: /var/log/mirrorbits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">GeoipDatabasePath: /usr/local/share/GeoIP/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">OutputMode: redirect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Gzip: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ListenAddress: localhost:8080</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RPCListenAddress: localhost:3390</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RedisAddress: 127.0.0.1:6379</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RedisDB: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TraceFileLocation: /mirrorsync</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RepositoryScanInterval: 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hashes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SHA256: On</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ConcurrentSync: 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ScanInterval: 30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CheckInterval: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Fallbacks:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     - URL: https://repo.jellyfin.org/master/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       CountryCode: ca</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       ContinentCode: na</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A few options are worth mentioning as they differ from the obvious defaults.</p><p><code>Repository</code> points towards the local repository path, the exact file(s) that are synchronized with <code>rsync</code> above.</p><p><code>GeoipDatabasePath</code> is a path to a local copy of the GeoIP database; this will be discussed later.</p><p><code>OutputMode</code> is set to <code>redirect</code> to give clients an HTTP 302 redirect to the file path. There are several options here, but the 302 seemed like the most robust, being well-supported by most HTTP-speaking programs and preventing caching of the response.</p><p><code>TraceFileLocation</code> points to a file which is used to judge the &quot;freshness&quot; of the mirrors. It should be a file which guarantees that the remote copies of the repository are in sync with the local instance, and must be under the <code>Repository</code> location.</p><p><code>Hashes</code> provides several options, but we use SHA256 hashing for simplicity and to match our own provided hashes.</p><p><code>RedisAddress</code> points to a local Redis instance that Mirrorbits uses to handle state.</p><p><code>ConcurrentSync</code>, <code>RepositoryScanInterval</code>, <code>ScanInterval</code>, and <code>CheckInterval</code> are times in minutes that Mirrorbits <em>should</em> be checking and synchronizing itself, but I&#x27;ve found these to be unreliable; I used a cron task to do these tasks manually instead.</p><p>Finally, <code>Fallbacks</code> provides a list of fallback mirrors. As mentioned above, the <code>/master</code> path provides the exact same content as <code>/releases</code>, only without being forwarded back to Mirrorbits and creating a loop. Without this fallback, if all mirrors are unavailable for any given file, either due to its newness or due to mirror failures, clients would not be able to download files at all. The fallback ensures there is still at least one source - the origin - that is not normally used, but can be just in case.</p><p>The next step was creating a SystemD service for Mirrorbits. The process requires some special options for reloads and stopping, so these are included here. Note also that I run Mirrorbits as <code>www-data</code>, the same user as NGiNX itself:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/systemd/system/mirorrbits.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Description=Mirrorbits redirector</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Documentation=https://github.com/etix/mirrorbits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">After=network.target</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Type=notify</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DynamicUser=yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LogsDirectory=mirrorbits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RuntimeDirectory=mirrorbits</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">User=www-data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PIDFile=/run/mirrorbits/mirrorbits.pid</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStart=/usr/local/bin/mirrorbits daemon -p /run/mirrorbits/mirrorbits.pid -debug</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecReload=/bin/kill -HUP $MAINPID</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStop=-/bin/kill -QUIT $MAINPID</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">TimeoutStopSec=5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">KillMode=mixed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, I added some cron jobs to ensure that the <code>TraceFileLocation</code> is updated regularly, and that the mirror is scanned and refreshed regularly - the things that Mirrorbits itself didn&#x27;t seem to be handling properly. The trace file is always updated 1 minute before the sync happens, while the mirror scan happens 1 minute after, to give the sync time to complete. The local repository is refreshed every minute to catch any new files as quickly as possible.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># /etc/cron.d/mirror-sync</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">11,26,41,56 *  * * *  root  /usr/bin/date +\%s | /usr/bin/tee /srv/repository/mirror/mirrorsync &amp;&gt;/dev/null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">13,28,42,58 *  * * *  root  /usr/local/bin/mirrorbits scan -all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">*           *  * * *  root  /usr/local/bin/mirrorbits refresh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-mirrors-to-mirrorbits">Adding Mirrors to Mirrorbits<a class="hash-link" href="#adding-mirrors-to-mirrorbits" title="Direct link to heading">​</a></h2><p>Once all the setup was completed and Mirrorbits running, I added the mirrors to the Mirrorbits system. This is a straightforward process using the Mirrorbits binary:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">mirrorbits add -http https://fra1.mirror.jellyfin.org -rsync rsync://fra1.mirror.jellyfin.org/mirror fra1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mirrorbits scan --enable fra1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mirrorbits refresh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once scanned, enabled, and refreshed, the mirror became active and and visible in the <code>/mirrorstats</code> output or on the CLI, ready to serve requests.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">joshua@build1.jellyfin.org ~ $ mirrorbits list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Identifier      STATE   SINCE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fra1            up      (Mon, 12 Apr 2021 07:15:29 UTC)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sgp1            up      (Mon, 12 Apr 2021 06:51:03 UTC)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tor1            up      (Sun, 11 Apr 2021 21:48:48 UTC)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sfo1            up      (Sun, 11 Apr 2021 17:43:27 UTC)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="geoip">GeoIP<a class="hash-link" href="#geoip" title="Direct link to heading">​</a></h2><p>One complication of using Mirrorbits is requiring a GeoIP database. It specifically requires the <code>GeoLite2</code> <code>mmdb</code> format to operate correctly. Unfortunately, this is no longer something that is provided freely. You must obtain this yourself, or find an alternative; I would prefer to use a freely available database, but I have yet to be able to find one that works with Mirrorbits. If you know of one, please let me know!</p><p>This database is extracted to the <code>GeoipDatabasePath</code> location and is loaded by Mirrorbits at runtime, providing the GeoIP information it then uses to direct clients to the nearest mirror server.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>All together, we hope this setup allows us to continue to scale our downloads for our users across the world. And I hope this post will help another admin of a small project who needs to distribute their downloads across many geo-diverse servers. Good luck!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/posts/a-note-about-privacy-and-expo"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">A Note About Privacy and Expo for iOS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/posts/android-on-fdroid"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Android app now on F-Droid</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prelude---pre-1060" class="table-of-contents__link toc-highlight">Prelude - Pre-10.6.0</a></li><li><a href="#enter-mirrorbits" class="table-of-contents__link toc-highlight">Enter Mirrorbits</a></li><li><a href="#file-layout" class="table-of-contents__link toc-highlight">File Layout</a></li><li><a href="#additional-vpses-and-synchronization" class="table-of-contents__link toc-highlight">Additional VPSes and Synchronization</a></li><li><a href="#web-server-configuration" class="table-of-contents__link toc-highlight">Web server Configuration</a></li><li><a href="#mirrorbits-the-workhorse" class="table-of-contents__link toc-highlight">Mirrorbits: The Workhorse</a></li><li><a href="#adding-mirrors-to-mirrorbits" class="table-of-contents__link toc-highlight">Adding Mirrors to Mirrorbits</a></li><li><a href="#geoip" class="table-of-contents__link toc-highlight">GeoIP</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/docs/getting-started">Documentation</a><span class="footer__link-separator">·</span><a href="https://features.jellyfin.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feature Requests</a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/contribute">Contribute</a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/contact">Contact</a></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/images/logo.svg" alt="Jellyfin Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="240" height="80"><img src="/images/logo.svg" alt="Jellyfin Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="240" height="80"></div><div class="footer__copyright">Site content is licensed <a href="http://creativecommons.org/licenses/by-nd/4.0/">CC-BY-ND-4.0</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.c3f67a5c.js"></script>
<script src="/assets/js/main.d391ae15.js"></script>
</body>
</html>